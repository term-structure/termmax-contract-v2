// SPDX-License-Identifier: MIT
pragma solidity ^0.8.27;

import {AggregatorV3Interface} from "@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol";
import {Ownable} from "@openzeppelin/contracts/access/Ownable.sol";
import {ITermMaxMarket} from "contracts/v1/ITermMaxMarket.sol";
import {ITermMaxOrder} from "contracts/v1/ITermMaxOrder.sol";
import {SwapUnit, ITermMaxRouter, TermMaxRouter} from "contracts/v1/router/TermMaxRouter.sol";
import {
    IGearingToken,
    GearingTokenEvents,
    AbstractGearingToken,
    GtConfig
} from "contracts/v1/tokens/AbstractGearingToken.sol";
import {PendleSwapV3AdapterV2} from "contracts/v2/router/swapAdapters/PendleSwapV3AdapterV2.sol";
import {OdosV2AdapterV2} from "contracts/v2/router/swapAdapters/OdosV2AdapterV2.sol";
import {IOracle} from "contracts/v1/oracle/IOracle.sol";
import {
    ForkBaseTestV2,
    TermMaxFactoryV2,
    MarketConfig,
    IERC20,
    MarketInitialParams,
    IERC20Metadata
} from "../mainnet-fork/ForkBaseTestV2.sol";
import {ITermMaxMarketV2} from "contracts/v2/ITermMaxMarketV2.sol";
import {ITermMaxRouterV2, TermMaxRouterV2, SwapPath, FlashRepayOptions} from "contracts/v2/router/TermMaxRouterV2.sol";
import {IWhitelistManager} from "contracts/v2/access/IWhitelistManager.sol";
import {OkxSwapAdapter} from "contracts/v2/router/swapAdapters/OkxSwapAdapter.sol";
import {console} from "forge-std/console.sol";

contract ForkOkxSwapAdapterV2 is ForkBaseTestV2 {
    string MAINNET_RPC_URL = vm.envString("MAINNET_RPC_URL");
    string DATA_PATH = string.concat(vm.projectRoot(), "/test/testdata/fork/mainnet.json");

    address okxRouter = 0x5E1f62Dac767b0491e3CE72469C217365D5B48cC;
    address okxApprovalAddress = 0x40aA958dd87FC8305b97f2BA922CDdCa374bcD7f;

    address constant tokenIn = 0x9dC44ae5BE187ECA9e2A67e33f27A4c91cEA1223;
    address constant tokenOut = 0xdAC17F958D2ee523a2206206994597C13D831ec7;
    uint256 blockNumber = 24287307;

    bytes data =
        hex"f2c4269600000000000000000000000000000000000000000000000000000000000347c40000000000000000000000009dc44ae5be187eca9e2a67e33f27a4c91cea1223000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000001b1ae4d6e2ef500000000000000000000000000000000000000000000000000000000000000612de1e000000000000000000000000000000000000000000000000000000006971977600000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001600000000000000000000000009dc44ae5be187eca9e2a67e33f27a4c91cea122300000000000000000000000000000000000000000000000000000000000000010000000000000000000000005745050e787f693ed21e4418d528f78ad9c374a600000000000000000000000000000000000000000000000000000000000000010000000000000000000000005745050e787f693ed21e4418d528f78ad9c374a6000000000000000000000000000000000000000000000000000000000000000180000000000000000001271000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000800000000000000000000000009dc44ae5be187eca9e2a67e33f27a4c91cea1223000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000020000000000000000000000006747bcaf9bd5a5f0758cbe08903490e45ddfacb50000000000000000000000006747bcaf9bd5a5f0758cbe08903490e45ddfacb500000000000000000000000000000000000000000000000000000000000000020000000000000000000000006747bcaf9bd5a5f0758cbe08903490e45ddfacb50000000000000000000000006747bcaf9bd5a5f0758cbe08903490e45ddfacb50000000000000000000000000000000000000000000000000000000000000002800000000000000001020320e0554a476a092703abdb3ef35c80e0d76d32939f0000000000000000010323f0c7bbec68d12a0d1830360f8ec58fa599ba1b0e9b00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000040000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000040000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000000000010000000000000000000000005e18e052517af66575105acff6a7f17ded3f10f200000000000000000000000000000000000000000000000000000000000000010000000000000000000000005e18e052517af66575105acff6a7f17ded3f10f200000000000000000000000000000000000000000000000000000000000000010000000000000000020327100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000080000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000053e2d6238da3000000320000000000000000000000000000000000000000000000000000000000000000";

    uint256 tokenInAmt = 480 ether;
    uint256 minTokenOut = 8e6;

    TermMaxRouterV2 router;
    OkxSwapAdapter okxSwapAdapter;

    function _getForkRpcUrl() internal view override returns (string memory) {
        return MAINNET_RPC_URL;
    }

    function _getDataPath() internal view override returns (string memory) {
        return DATA_PATH;
    }

    function _finishSetup() internal override {
        vm.rollFork(blockNumber);
        okxSwapAdapter = new OkxSwapAdapter();
        vm.label(address(okxSwapAdapter), "OkxSwapAdapter");
        vm.label(tokenIn, "tokenIn");
        vm.label(tokenOut, "tokenOut");
        address admin = vm.randomAddress();

        vm.startPrank(admin);
        IWhitelistManager whitelistManager;
        (router, whitelistManager) = deployRouter(admin);
        router.setWhitelistManager(address(whitelistManager));

        address[] memory adapters = new address[](1);
        adapters[0] = address(okxSwapAdapter);
        whitelistManager.batchSetWhitelist(adapters, IWhitelistManager.ContractModule.ADAPTER, true);
        vm.stopPrank();
        // prepare swap data
        data = abi.encode(okxRouter, okxApprovalAddress, data);
    }

    function testSwapExactInToken() public {
        address user = vm.addr(1);
        vm.label(user, "user");
        deal(tokenIn, user, tokenInAmt);
        vm.startPrank(user);
        IERC20(tokenIn).approve(address(router), tokenInAmt);

        SwapUnit[] memory swapUnits = new SwapUnit[](2);
        swapUnits[0] =
            SwapUnit({adapter: address(okxSwapAdapter), tokenIn: tokenIn, tokenOut: tokenOut, swapData: data});
        swapUnits[1] = SwapUnit({adapter: address(0), tokenIn: tokenOut, tokenOut: address(0), swapData: hex""});
        SwapPath[] memory swapPaths = new SwapPath[](1);
        swapPaths[0] = SwapPath({units: swapUnits, recipient: user, inputAmount: tokenInAmt, useBalanceOnchain: false});

        uint256 tokenOutBefore = IERC20(tokenOut).balanceOf(user);
        uint256 tokenInBefore = IERC20(tokenIn).balanceOf(user);
        router.swapTokens(swapPaths);
        uint256 tokenOutAfter = IERC20(tokenOut).balanceOf(user);
        uint256 tokenInAfter = IERC20(tokenIn).balanceOf(user);
        assertGe(tokenOutAfter - tokenOutBefore, minTokenOut);
        assertEq(tokenInBefore - tokenInAfter, tokenInAmt);
        console.log("tokenOut out", tokenOutAfter - tokenOutBefore);
        console.log("tokenIn in", tokenInBefore - tokenInAfter);
    }
}
