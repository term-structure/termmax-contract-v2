// SPDX-License-Identifier: MIT
pragma solidity ^0.8.27;

import {AggregatorV3Interface} from "@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol";
import {Ownable} from "@openzeppelin/contracts/access/Ownable.sol";
import {ITermMaxMarket} from "contracts/v1/ITermMaxMarket.sol";
import {ITermMaxOrder} from "contracts/v1/ITermMaxOrder.sol";
import {SwapUnit, ITermMaxRouter, TermMaxRouter} from "contracts/v1/router/TermMaxRouter.sol";
import {
    IGearingToken,
    GearingTokenEvents,
    AbstractGearingToken,
    GtConfig
} from "contracts/v1/tokens/AbstractGearingToken.sol";
import {PendleSwapV3AdapterV2} from "contracts/v2/router/swapAdapters/PendleSwapV3AdapterV2.sol";
import {OdosV2AdapterV2} from "contracts/v2/router/swapAdapters/OdosV2AdapterV2.sol";
import {IOracle} from "contracts/v1/oracle/IOracle.sol";
import {
    ForkBaseTestV2,
    TermMaxFactoryV2,
    MarketConfig,
    IERC20,
    MarketInitialParams,
    IERC20Metadata
} from "../mainnet-fork/ForkBaseTestV2.sol";
import {ITermMaxMarketV2} from "contracts/v2/ITermMaxMarketV2.sol";
import {ITermMaxRouterV2, TermMaxRouterV2, SwapPath, FlashRepayOptions} from "contracts/v2/router/TermMaxRouterV2.sol";
import {IWhitelistManager} from "contracts/v2/access/IWhitelistManager.sol";
import {OkxSwapAdapter} from "contracts/v2/router/swapAdapters/OkxSwapAdapter.sol";
import {console} from "forge-std/console.sol";

contract ForkOkxSwapAdapterV2 is ForkBaseTestV2 {
    string MAINNET_RPC_URL = vm.envString("MAINNET_RPC_URL");
    string DATA_PATH = string.concat(vm.projectRoot(), "/test/testdata/fork/mainnet.json");

    address okxRouter = 0x2E1Dee213BA8d7af0934C49a23187BabEACa8764;
    address okxApprovalAddress = 0x40aA958dd87FC8305b97f2BA922CDdCa374bcD7f;
    address constant WBTC = 0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599;
    address constant USDC = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48;
    uint256 blockNumber = 23616233;
    uint256 timestamp = 1760931959;
    bytes data =
        hex"b80c2f090000000000000000000000000000000000000000000000000000000000033d580000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000009896800000000000000000000000000000000000000000000000000000000284677d370000000000000000000000000000000000000000000000000000000068f5bf06000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000c4000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000989680000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000084000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001600000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000000000000000000000000000000000000000000100000000000000000000000026cd030a7307e168ec9ccc30137629a5ed8bacd2000000000000000000000000000000000000000000000000000000000000000100000000000000000000000026cd030a7307e168ec9ccc30137629a5ed8bacd2000000000000000000000000000000000000000000000000000000000000000100000000000000000000271037f6df71b40c50b2038329cabf5fda3682df1ebf0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000800000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000097815b4200000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000010000000000000000000000001d27ad3613e84e201bc87929590f95e75454cdc000000000000000000000000000000000000000000000000000000000000000010000000000000000000000001d27ad3613e84e201bc87929590f95e75454cdc00000000000000000000000000000000000000000000000000000000000000001000000000000000000002710a540ec8c73322200d68e1b86c471a5c850854f220000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003e00000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005d1a34369686ae59ac97ae4e1df5635ffda9ee7c000000000000000000000000129b3d9a0a6e4beab88f5cb1e57995d72a6e24f10000000000000000000000001d27ad3613e84e201bc87929590f95e75454cdc0000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000000000000000000000000000260324a5e87605e7000000000000000000000000000000000000000000000000000000028aa6d22a000000000000000000000000000000000000000000000000000000028765fca20000000000000000000000000000000000000000000000000000000068f5b1320000000000000000000000000000000000000000000000000c800dc0ebdf1a340000000000000000000000000000000000000000000000000000000068f5b0fe0000000000000000000000000000000000000000000000000000000068f5b11c0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000596d393aaefa7478cba8d90aaba91f2f100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002800000000000000000000000006044eef7179034319e2c8636ea885b37cbfa9aba0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000414264ee2a0010ed7e8e5e705af8c237e2167327bf000ed1527511fe6198f948167236eca860176a0710d62678c072a9e0577fabe5105c316a8ad9d52c441bdc7c1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041bfd92f5fd1b6df26290cdb444354f8e26f492f017d242b29cf654ea2a0f77e846c73ba5ad88a8847c7f9e57e8e33e2e91f5c873d8041b734566c6abfdb1c5ff61b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000000000000000000010000000000000000000000005745050e787f693ed21e4418d528f78ad9c374a600000000000000000000000000000000000000000000000000000000000000010000000000000000000000005745050e787f693ed21e4418d528f78ad9c374a600000000000000000000000000000000000000000000000000000000000000010000000000000000000027100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000080000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000";

    TermMaxRouterV2 router;
    OkxSwapAdapter okxSwapAdapter;

    function _getForkRpcUrl() internal view override returns (string memory) {
        return MAINNET_RPC_URL;
    }

    function _getDataPath() internal view override returns (string memory) {
        return DATA_PATH;
    }

    function _finishSetup() internal override {
        vm.roll(blockNumber);
        vm.warp(timestamp);
        okxSwapAdapter = new OkxSwapAdapter();
        vm.label(address(okxSwapAdapter), "OkxSwapAdapter");
        vm.label(WBTC, "WBTC");
        vm.label(USDC, "USDC");
        address admin = vm.randomAddress();

        vm.startPrank(admin);
        IWhitelistManager whitelistManager;
        (router, whitelistManager) = deployRouter(admin);
        router.setWhitelistManager(address(whitelistManager));

        address[] memory adapters = new address[](1);
        adapters[0] = address(okxSwapAdapter);
        whitelistManager.batchSetWhitelist(adapters, IWhitelistManager.ContractModule.ADAPTER, true);
        vm.stopPrank();
        // prepare swap data
        data = abi.encode(okxRouter, okxApprovalAddress, data);
    }

    function testSwapExactInToken() public {
        address user = vm.addr(1);
        vm.label(user, "user");
        uint256 btcAmt = 0.1e8;
        uint256 wantToSellWBTC = 0.1e8;
        uint256 minUSDCOut = 10000e6;
        deal(WBTC, user, btcAmt);
        vm.startPrank(user);
        IERC20(WBTC).approve(address(router), btcAmt);

        SwapUnit[] memory swapUnits = new SwapUnit[](1);
        swapUnits[0] = SwapUnit({adapter: address(okxSwapAdapter), tokenIn: WBTC, tokenOut: USDC, swapData: data});
        SwapPath[] memory swapPaths = new SwapPath[](1);
        swapPaths[0] =
            SwapPath({units: swapUnits, recipient: user, inputAmount: wantToSellWBTC, useBalanceOnchain: false});

        uint256 usdcBefore = IERC20(USDC).balanceOf(user);
        uint256 btcBefore = IERC20(WBTC).balanceOf(user);
        router.swapTokens(swapPaths);
        uint256 usdcAfter = IERC20(USDC).balanceOf(user);
        uint256 btcAfter = IERC20(WBTC).balanceOf(user);
        assertGe(usdcAfter - usdcBefore, minUSDCOut);
        assertEq(btcBefore - btcAfter, wantToSellWBTC);
        console.log("usdc out", usdcAfter - usdcBefore);
        console.log("btc in", btcBefore - btcAfter);
    }
}
