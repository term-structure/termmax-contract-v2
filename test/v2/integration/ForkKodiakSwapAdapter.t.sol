// SPDX-License-Identifier: MIT
pragma solidity ^0.8.27;

import {AggregatorV3Interface} from "@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol";
import {Ownable} from "@openzeppelin/contracts/access/Ownable.sol";
import {ITermMaxMarket} from "contracts/v1/ITermMaxMarket.sol";
import {ITermMaxOrder} from "contracts/v1/ITermMaxOrder.sol";
import {SwapUnit, ITermMaxRouter, TermMaxRouter} from "contracts/v1/router/TermMaxRouter.sol";
import {
    IGearingToken,
    GearingTokenEvents,
    AbstractGearingToken,
    GtConfig
} from "contracts/v1/tokens/AbstractGearingToken.sol";
import {PendleSwapV3AdapterV2} from "contracts/v2/router/swapAdapters/PendleSwapV3AdapterV2.sol";
import {OdosV2AdapterV2} from "contracts/v2/router/swapAdapters/OdosV2AdapterV2.sol";
import {IOracle} from "contracts/v1/oracle/IOracle.sol";
import {
    ForkBaseTestV2,
    TermMaxFactoryV2,
    MarketConfig,
    IERC20,
    MarketInitialParams,
    IERC20Metadata
} from "../mainnet-fork/ForkBaseTestV2.sol";
import {ITermMaxMarketV2} from "contracts/v2/ITermMaxMarketV2.sol";
import {ITermMaxRouterV2, TermMaxRouterV2, SwapPath, FlashRepayOptions} from "contracts/v2/router/TermMaxRouterV2.sol";
import {IWhitelistManager} from "contracts/v2/access/IWhitelistManager.sol";
import {KodiakSwapAdapter, IKodiakRouter} from "contracts/v2/router/swapAdapters/KodiakSwapAdapter.sol";
import {console} from "forge-std/console.sol";

contract ForkKodiakSwapAdapter is ForkBaseTestV2 {
    string MAINNET_RPC_URL = vm.envString("MAINNET_RPC_URL");
    string DATA_PATH = string.concat(vm.projectRoot(), "/test/testdata/fork/mainnet.json");

    address kodiakRouter = 0x43Dac637c4383f91B4368041E7A8687da3806Cae;
    address okxApprovalAddress = 0x40aA958dd87FC8305b97f2BA922CDdCa374bcD7f;
    address constant WETH = 0x2F6F07CDcf3588944Bf4C42aC74ff24bF56e7590;
    address constant USDC = 0x549943e04f40284185054145c6E4e9568C1D3241;
    uint256 blockNumber = 12321524;
    uint256 timestamp = 1761551704;

    TermMaxRouterV2 router;
    KodiakSwapAdapter kodiakSwapAdapter;

    function _getForkRpcUrl() internal view override returns (string memory) {
        return MAINNET_RPC_URL;
    }

    function _getDataPath() internal view override returns (string memory) {
        return DATA_PATH;
    }

    function _finishSetup() internal override {
        vm.roll(blockNumber);
        vm.warp(timestamp);
        kodiakSwapAdapter = new KodiakSwapAdapter();
        vm.label(address(kodiakSwapAdapter), "KodiakSwapAdapter");
        vm.label(WETH, "WETH");
        vm.label(USDC, "USDC");
        address admin = vm.randomAddress();

        vm.startPrank(admin);
        IWhitelistManager whitelistManager;
        (router, whitelistManager) = deployRouter(admin);
        router.setWhitelistManager(address(whitelistManager));

        address[] memory adapters = new address[](1);
        adapters[0] = address(kodiakSwapAdapter);
        whitelistManager.batchSetWhitelist(adapters, IWhitelistManager.ContractModule.ADAPTER, true);
        vm.stopPrank();
    }

    function testSwapExactInToken() public {
        address user = vm.addr(1);
        vm.label(user, "user");
        /**
         * Prepare swap data
         */
        IKodiakRouter.InputAmount memory input = IKodiakRouter.InputAmount({amount: 1 ether, token: WETH, wrap: false});
        IKodiakRouter.OutputAmount memory output = IKodiakRouter.OutputAmount({
            minAmountOut: 4108446914,
            token: USDC,
            unwrap: false,
            receiver: address(0) // to be set later
        });
        IKodiakRouter.SwapData memory swapDataStruct = IKodiakRouter.SwapData({
            router: 0x6131B5fae19EA4f9D964eAc0408E4408b66337b5,
            data: hex"e21fd0e9000000000000000000000000000000000000000000000000000000000000002000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000da00000000000000000000000000000000000000000000000000000000000000fe00000000000000000000000000000000000000000000000000000000000000ce000000000000000000de0b6b3a764000000000000000000000de0b6b3a7640000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000041868b27289f536f16d34aa07e33d1b5e206295716043c849267a0f567a6fda9c53e5d15c5df3fd21c242d7dc67650481f8d2c0d96b1403034584d8e86f4b1c7391c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000be000000000000000000000000043dac637c4383f91b4368041e7a8687da3806cae0000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000018000000000000000000d2f13f7789f000000000000000000000e92596fd629000000000000000000000de0b6b3a7640000000000000000000000000000fa5a38a300000000000000000000000000000000000000000010680000000f42400000000000000000000000000000004f82e73edb06d29ff62c91ec8f5ff06571bdeb29000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000029e8d608000000000000000000000000000000000000000000000000000000000000000bc0000000000000000000000000000000000000000000000000000000000000000161f598cd0000000000000000f5e7837708e279c36073ea6fbd205746bc0a2a2b000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000004800000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000084000000000000000000000000000000000000000000000000000000000000009a00000000000000000000000002f6f07cdcf3588944bf4c42ac74ff24bf56e75908000000000000000000000e8d4a5100000000000000000000de0b6b3a7640000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000007a1fe16027700003b9d6e0900000000000000015455c918e405a2831fbff8595c0aae35ee3db9d1000000000000000000000000000000000000000000000000000000000000008000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb000000000000000000000000000000000000000000000000000000000000000400000000000000000000000003c098ca2e84143742a7dcec3a341cabdd706412b000000000000000000000000ff53611968f1e5ca45cfca7918447e7f5776f6d3000000000000000000000000000000000000000000000000063eb89da4ed00000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000043dac637c4383f91b4368041e7a8687da3806cae00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000555e30da8f98308edb960aa94c0db47230d2b9c80000000000000000000000000000001000000000000000000000000001e7eff00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000001e7eff3b9d6e0900000000000000025455c918e405a2831fbff8595c0aae35ee3db9d1000000000000000000000000000000000000000000000000000000000000008000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000ad7b9583a24346065fcd5731bdd600719497d28500000000000000000000000000000000000000123e8cf6dc30beed705f1241c6000000000000000000000000779ded0c9e1022225f8e0630b35a9b54be7137368000000000000000000000000000090500000000000000000000000089ad6fa60000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000089ad6fa63b9d6e0900000000000000055455c918e405a2831fbff8595c0aae35ee3db9d1000000000000000000000000000000000000000000000000000000000000008000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000cd1929ee788b25581a2b3ac55a138a14347d33040000000000000000000000000000000000000001000346d6ff11672ae55ad00f0000000000000000000000002f6f07cdcf3588944bf4c42ac74ff24bf56e7590800000000000000000000068c61714000000000000000000063eb89da4ed000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000429d069189e00003b9d6e0900000000000000055455c918e405a2831fbff8595c0aae35ee3db9d1000000000000000000000000000000000000000000000000000000000000008000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000069fbaa80b560e425ff0ab0222335dc7f1eca7d9000000000000000000000000000000000000000000002498be2a1031ed8f756d50000000000000000000000000000000000000000000000000214e8348c4f00000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000043dac637c4383f91b4368041e7a8687da3806cae00000000000000000000000000000000000000000000000000000000000000000000000000000000000000002f6f07cdcf3588944bf4c42ac74ff24bf56e7590800000000000000000000022ecb25c0000000000000000000214e8348c4f00000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000214e8348c4f00006b5fe1f200000000000000050c3b706efa1da39450c968e669fdc442fc375021000000000000000000000000000000000000000000000000000000000000008000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb000000000000000000000000000000000000000000000000000000000000000200000000000000000000000005520385bfcf07ec87c4c53a7d8d65595dff69fa4000000000000000000000000549943e04f40284185054145c6e4e9568c1d324180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002f6f07cdcf3588944bf4c42ac74ff24bf56e7590000000000000000000000000549943e04f40284185054145c6e4e9568c1d3241000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000043dac637c4383f91b4368041e7a8687da3806cae0000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000f7d951aa00000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000000100000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000de0b6b3a7640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000027e7b22536f75726365223a224b6f6469616b303031222c22416d6f756e74496e555344223a22343139362e383639363531353938343132222c22416d6f756e744f7574555344223a22343230362e313233313139303932303135222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2234323030323136373338222c2254696d657374616d70223a313736313535313532352c22526f7574654944223a2264666236653964632d383564302d343031342d616364382d6631646261356338643634333a61346461623638652d333933312d346362382d386532662d633163643336303461343566222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22507071796f616244376a4d4f4a5641654638654f7961686b5a2b4c344e3147514132724944386a38563142536953495948396c586559463177712f7174686e504b75325834707367672b5238634c4e554e4b52494730697436686f7637507143422f4a61746a6737627873694d376447476d5553446f49564e44424e535757357a497a71456f42536c7a544e746c537151454876444b5569783863665a46583334706d335a716d65596b7347584367757837434a79616a367732376f2f5672717779795439654c4234652f47575770785a69765a39774e4d484546796f6c51387569665645796b59796468475264514e4f4b71694434474c587a556a3678416d6d53776b436b707141554d6a614e78412f4344623045347161436f566477436e4c31634f503568784c4253552f4946675544506639573374547958645830776173494a526c49797547616b6a504e2b545978754176513d3d227d7d0000"
        });
        IKodiakRouter.FeeData memory feeData =
            IKodiakRouter.FeeData({feeQuote: 4198103214, surplusFeeBps: 0, refCode: 0, referrerFeeBps: 0});
        bytes memory data = abi.encode(kodiakRouter, input, output, swapDataStruct, feeData);
        uint256 ethAmt = 1 ether;
        uint256 wantToSellWETH = 1 ether;
        uint256 minUSDCOut = 2000e6;
        deal(WETH, user, ethAmt);
        vm.startPrank(user);
        IERC20(WETH).approve(address(router), ethAmt);

        SwapUnit[] memory swapUnits = new SwapUnit[](1);
        swapUnits[0] = SwapUnit({adapter: address(kodiakSwapAdapter), tokenIn: WETH, tokenOut: USDC, swapData: data});
        SwapPath[] memory swapPaths = new SwapPath[](1);
        swapPaths[0] =
            SwapPath({units: swapUnits, recipient: user, inputAmount: wantToSellWETH, useBalanceOnchain: false});

        uint256 usdcBefore = IERC20(USDC).balanceOf(user);
        uint256 ethBefore = IERC20(WETH).balanceOf(user);
        router.swapTokens(swapPaths);
        uint256 usdcAfter = IERC20(USDC).balanceOf(user);
        uint256 ethAfter = IERC20(WETH).balanceOf(user);
        assertGe(usdcAfter - usdcBefore, minUSDCOut);
        assertEq(ethBefore - ethAfter, wantToSellWETH);
        console.log("usdc out", usdcAfter - usdcBefore);
        console.log("eth in", ethBefore - ethAfter);
    }
}
